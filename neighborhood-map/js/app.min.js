var shouter=new ko.subscribable,AddInfoViewModel=function(){{var e=this,o=$("#wikibtn");$("#flickrbtn")}e.wikiEnabled=ko.observable(!1),e.flickrEnabled=ko.observable(!1),e.addInfoLoading=ko.observable(!1),e.showAddInfoWindow=ko.observable(!1),e.wikiEnabled.subscribe(function(e){shouter.notifySubscribers(e,"wikiEnabled")}),e.flickrEnabled.subscribe(function(e){shouter.notifySubscribers(e,"flickrEnabled")}),e.toggleWiki=function(){e.wikiEnabled(!e.wikiEnabled()),e.wikiEnabled()?(o.addClass("selected"),e.flickrEnabled(!1)):o.removeClass("selected")},e.toggleFlickr=function(){e.flickrEnabled(!e.flickrEnabled()),e.flickrEnabled()&&e.wikiEnabled(!1)},e.showAddInfoWindow=ko.computed(function(){var o=$(".addinfo-content");return e.flickrEnabled()||e.wikiEnabled()?(o.addClass("show-addinfo"),!0):e.flickrEnabled()||e.wikiEnabled()?void 0:(o.removeClass("show-addinfo"),!1)})},WikiViewModel=function(){function e(e){if(n.wikiEnabled()&&!(n.wikiPages().length>0)){var i=r+"format=json&action=query&list=search&srsearch="+e+"&srlimit=5&callback=?",a=setTimeout(function(){n.wikiErrorMsg("Failed to get wikipedia resources"),n.loading(!1)},3e3);n.loading(!0),n.wikiErrorMsg(""),$.ajax({url:i,dataType:"jsonp",success:function(e){for(var r=0;r<e.query.search.length;r++)n.wikiPages.push({title:e.query.search[r].title,link:o(e.query.search[r].title),snippet:e.query.search[r].snippet});clearTimeout(a),n.loading(!1)}})}}function o(e){return i+e}var n=this,r="http://en.wikipedia.org/w/api.php?",i="http://en.wikipedia.org/wiki/";n.wikiPages=ko.observableArray([]),n.myNeighborhood=ko.observable(""),n.wikiEnabled=ko.observable(!1),n.wikiErrorMsg=ko.observable(""),n.loading=ko.observable(!1),shouter.subscribe(function(e){n.wikiEnabled(e)},n,"wikiEnabled"),shouter.subscribe(function(e){n.myNeighborhood(e),n.wikiPages([])},n,"neighborhood"),n.wikiEnabledComputed=ko.computed(function(){n.wikiEnabled()&&e(n.myNeighborhood())})},FlickrViewModel=function(){function e(){var e=(Date.now()-2592e3,1),a=1,t=n.neighborhoodLoc().lat(),s=n.neighborhoodLoc().lng(),l=n.myNeighborhood(),c=20,d=r+"?method=flickr.photos.search&api_key="+i+"&lat="+t+"&lng="+s+"&text="+l+"&privacy_filter="+e+"&content_type="+a+"&per_page="+c,b=setTimeout(function(){n.flickrErrorMsg("Failed to load Flickr images")},5e3);$.ajax({url:d,data:"format=json",jsonp:"jsoncallback",dataType:"jsonp",success:function(e){for(var r=0;r<e.photos.photo.length;r++)n.neighborhoodImages.push({title:e.photos.photo[r].title,owner:e.photos.photo[r].owner,pic_thumb:o(e.photos.photo[r],"z"),pic:o(e.photos.photo[r],"b")});clearTimeout(b)}})}function o(e,o){return"https://farm"+e.farm+".staticflickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_"+o+".jpg"}var n=this,r="https://api.flickr.com/services/rest/",i="ae6f6113a6236df9a8fe6eb32616175d";n.flickrEnabled=ko.observable(!1),n.neighborhoodImages=ko.observableArray([]),n.neighborhoodLoc=ko.observable(),n.myNeighborhood=ko.observable(),n.flickrErrorMsg=ko.observable(""),shouter.subscribe(function(e){n.flickrEnabled(e)},n,"flickrEnabled"),shouter.subscribe(function(e){n.neighborhoodLoc(e)},n,"neighborhoodLoc"),shouter.subscribe(function(e){n.myNeighborhood(e),n.neighborhoodImages([])},n,"neighborhood"),n.computedLoadFlickr=ko.computed(function(){!n.flickrEnabled()||n.neighborhoodImages().length>0||e()})},MapViewModel=function(){function e(){shouter.notifySubscribers(k.myNeighborhood(),"neighborhood");var e={zoom:14,mapTypeControl:!0,panControl:!0,panControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_CENTER},streetViewControl:!1};b=new google.maps.Map(document.querySelector("#map"),e),f=new google.maps.InfoWindow,h=new google.maps.places.PlacesService(b),g=new google.maps.BicyclingLayer,u=new google.maps.TrafficLayer,p=new google.maps.TransitLayer,google.maps.event.addDomListener(window,"resize",function(){var e=b.getCenter();google.maps.event.trigger(b,"resize"),b.setCenter(e)})}function o(){y=[],c(),k.nearbyPlaces([]),k.keywordSearch(""),k.chosenMarker("");var e={query:k.myNeighborhood()};h.textSearch(e,n)}function n(e,o){if(o===v){var n=e[0],i=n.geometry.location.lat(),a=n.geometry.location.lng(),t=new google.maps.LatLng(i,a);shouter.notifySubscribers(t,"neighborhoodLoc"),b.setCenter(t),r()}else k.errorMsg("Failed to load neighborhood due to the following issue: "+o)}function r(){var e={location:b.getCenter(),radius:w,types:m};h.nearbySearch(e,i)}function i(e,o){if(o===v){var n=function(e,o){if(k.loading(!0),o>=e.length)return void k.loading(!1);var r={placeId:e[o].place_id};h.getDetails(r,function(r,i){i===v?(k.nearbyPlaces.push({id:r.id,name:r.name,icon:r.icon,address:r.formatted_address,phone:r.formatted_phone_number,types:r.types,rating:r.user_ratings_total,website:r.website,reviews:r.reviews,photos:r.photos,showItem:!0}),y.push(new google.maps.Marker({position:r.geometry.location,name:r.name,address:r.formatted_address,phone:r.formatted_phone_number,showMarker:!0})),s(y[o],r),n(e,o+1),k.noPlacesToShow(!1)):i===E&&window.setTimeout(function(){n(e,o)},200)})};n(e,0)}else k.errorMsg("Failed to load neighborhood places due to :"+o)}function a(){var e=k.keywordSearch().split(" "),o=k.nearbyPlaces();k.nearbyPlaces([]),k.noPlacesToShow(!0),o.forEach(function(o){for(var n=o.name,r=!1,i=0;i<e.length;i++){if(1===e.length&&""===e[i])r=!0;else if(n.toLowerCase().indexOf(e[i].toLowerCase())>=0)r=!0;else for(var a=0;a<o.types.length;a++)if(o.types[a].toLowerCase().indexOf(e[i].toLowerCase())>=0){r=!0;break}k.noPlacesToShow()&&k.noPlacesToShow(r?!1:!0),o.showItem=r,t(o,r),k.nearbyPlaces.push(o)}}),k.nearbyPlaces(o),l(y)}function t(e,o){y.forEach(function(n){e.name===n.name&&(n.showMarker=o)})}function s(e){e.setMap(b),google.maps.event.addListener(e,"click",k.selectItem),google.maps.event.addListener(f,"closeclick",function(){""!==k.chosenMarker()&&null!==k.chosenMarker().getAnimation()&&k.chosenMarker().setAnimation(null),k.chosenMarker(""),k.chosenPlace("")})}function l(){c();for(var e=0;e<y.length;e++)y[e].showMarker&&y[e].setMap(b)}function c(){for(var e=0;e<y.length;e++)y[e].setMap(null)}function d(){g.setMap(k.bikeLayerEnabled()?b:null),p.setMap(k.transitLayerEnabled()?b:null),u.setMap(k.trafficLayerEnabled()?b:null)}var b,h,f,g,u,p,k=this,m=["bakery","bar","cafe","food","movie_theater","museum","park","night_club","restaurant","shopping_mall","zoo"],w=2e3,y=[],v=google.maps.places.PlacesServiceStatus.OK,E=google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT;k.myNeighborhood=ko.observable(""),k.neighborhoodLoc=ko.observable(),k.nearbyPlaces=ko.observableArray([]),k.noPlacesToShow=ko.observable(!0),k.keywordSearch=ko.observable(""),k.chosenMarker=ko.observable(""),k.chosenPlace=ko.observable(""),k.bikeLayerEnabled=ko.observable(!1),k.trafficLayerEnabled=ko.observable(!1),k.transitLayerEnabled=ko.observable(!1),k.showAddInfoWindow=ko.observable(!1),k.loading=ko.observable(!1),k.errorMsg=ko.observable(""),k.noInternet=ko.observable("undefined"==typeof google?!0:!1),k.myNeighborhood.subscribe(function(e){shouter.notifySubscribers(e,"neighborhood")}),k.toggleBikeLayer=function(){k.bikeLayerEnabled(!k.bikeLayerEnabled()),d()},k.toggleTrafficLayer=function(){k.trafficLayerEnabled(!k.trafficLayerEnabled()),d()},k.toggleTransitLayer=function(){k.transitLayerEnabled(!k.transitLayerEnabled()),d()},k.selectItem=function(){var e,o;if(this.hasOwnProperty("map")){o=this;for(var n=0;n<k.nearbyPlaces().length;n++)if(this.name===k.nearbyPlaces()[n].name){e=k.nearbyPlaces()[n];break}console.log(e.id);var r=document.getElementById(e.id);r.scrollIntoViewIfNeeded()}else{e=this;for(var n=0;n<y.length;n++)if(y[n].name===this.name){o=y[n];break}}k.chosenPlace(e),k.chosenMarker(o),b.panTo(o.position),f.setContent("<div class='infowindow-div noscroll'><h6>"+o.name+"</h6><p>"+o.address+"</p><span>"+o.phone+"</span></div>"),f.open(b,o)},k.scrollPlacesList=function(e){var o=$(".places-list-wrapper .content"),n=o[0].scrollLeft+o.width()/2*e;console.log(n),o.animate({scrollLeft:n},600)},e(),$(window).resize(function(){$(".places-list-wrapper .content")[0].scrollLeft=0}),k.computedNeighborhood=ko.computed(function(){""!==k.myNeighborhood()&&o()}),k.markerAnimationIsRunning=ko.computed(function(){return""!==k.chosenMarker()?(y.forEach(function(e){e.setAnimation(null)}),null!==k.chosenMarker().getAnimation()?(k.chosenMarker().setAnimation(null),!1):(k.chosenMarker().setAnimation(google.maps.Animation.BOUNCE),!0)):void 0}),k.computedKeywordSearch=ko.computed(function(){a()})},masterViewModel=function(){this.AddInfoViewModel=new AddInfoViewModel,this.WikiViewModel=new WikiViewModel,this.MapViewModel=new MapViewModel};ko.applyBindings(new masterViewModel);